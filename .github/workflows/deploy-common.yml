name: Common Deployment Workflow

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to (development, staging, production)'
        required: true
        type: string
      cluster_name:
        description: 'EKS cluster name'
        required: true
        type: string
      values_file:
        description: 'Helm values file to use'
        required: true
        type: string
      docker_tag_suffix:
        description: 'Suffix for Docker tag (latest, staging-latest, production-latest)'
        required: true
        type: string
      enable_production_validations:
        description: 'Enable production-specific validations and safety measures'
        required: false
        type: boolean
        default: false
      version_tag:
        description: 'Version tag for production deployments'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ACCESS_KEY_ID:
        description: 'AWS Access Key ID for ECR'
        required: true
      AWS_SECRET_ACCESS_KEY:
        description: 'AWS Secret Access Key for ECR'
        required: true
      MONGO_URI:
        description: 'MongoDB URI'
        required: true
      ENCRYPTION_KEY:
        description: 'Encryption Key'
        required: true
      SHOPIFY_API_KEY:
        description: 'Shopify API Key'
        required: true
      SHOPIFY_API_SECRET:
        description: 'Shopify API Secret'
        required: true
      REDIS_URL:
        description: 'Redis URL for cache (optional)'
        required: false

env:
  AWS_DEFAULT_REGION: us-east-1

jobs:
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version_tag || github.sha }}

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
          cache: true

      - name: ğŸ“¦ Download dependencies
        run: |
          echo "ğŸ“¦ Downloading Go modules..."
          go mod download
          go mod tidy

      - name: ğŸ§ª Run Unit Tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          go test -v ./internal/...

  build:
    needs: unit-tests
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version_tag || github.sha }}

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: ğŸ” Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          mask-password: true

      - name: ğŸ·ï¸ Determine Docker tags
        id: tags
        run: |
          IMAGE_TAG=${{ inputs.version_tag || github.sha }}
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Using image tag: ${IMAGE_TAG}"

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ vars.DOCKER_REGISTRY_URL }}/shopify-integration-service:${{ steps.tags.outputs.image_tag }}
            ${{ vars.DOCKER_REGISTRY_URL }}/shopify-integration-service:${{ inputs.docker_tag_suffix }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version_tag || github.sha }}

      - name: ğŸ”‘ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: ğŸ” Update kubeconfig
        run: |
          echo "ğŸ” Updating kubeconfig for cluster: ${{ inputs.cluster_name }}"
          aws eks update-kubeconfig --name ${{ inputs.cluster_name }} --region us-east-1

      - name: ğŸ” Verify cluster access
        run: |
          echo "ğŸ” Verifying cluster access..."
          kubectl cluster-info --request-timeout=30s
          kubectl auth can-i get pods --namespace archie-core

      - name: âš™ï¸ Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: ğŸ§¹ Clean up stuck Helm operations
        run: |
          echo "ğŸ§¹ Checking for stuck Helm operations..."

          # Check if there are any pending operations
          PENDING_OPERATIONS=$(helm list --all-namespaces --pending --output json | jq length)

          if [ "$PENDING_OPERATIONS" -gt 0 ]; then
            echo "âš ï¸  Found $PENDING_OPERATIONS pending Helm operation(s). Attempting cleanup..."

            # Try to rollback any pending releases in our namespace
            helm list --namespace archie-core --pending --short | while read release; do
              if [ -n "$release" ]; then
                echo "ğŸ”„ Rolling back stuck release: $release"
                helm rollback "$release" --namespace archie-core || echo "âŒ Rollback failed for $release"
              fi
            done

            # If archie-core-shopify-layer specifically is stuck, try to force cleanup
            if helm status archie-core-shopify-layer --namespace archie-core >/dev/null 2>&1; then
              RELEASE_STATUS=$(helm status archie-core-shopify-layer --namespace archie-core -o json | jq -r '.info.status')
              if [ "$RELEASE_STATUS" = "pending-install" ] || [ "$RELEASE_STATUS" = "pending-upgrade" ]; then
                echo "ğŸ”¨ archie-core-shopify-layer is stuck in $RELEASE_STATUS state. Forcing cleanup..."
                kubectl delete secret -l owner=helm,name=archie-core-shopify-layer --namespace archie-core || true
                echo "âœ… Cleaned up stuck archie-core-shopify-layer release"
              fi
            fi
          else
            echo "âœ… No pending Helm operations found"
          fi

      - name: ğŸ’¾ Backup current release (production only)
        if: ${{ inputs.enable_production_validations }}
        run: |
          echo "ğŸ’¾ Creating backup of current production release..."
          
          if helm status archie-core-shopify-layer --namespace archie-core >/dev/null 2>&1; then
            CURRENT_REVISION=$(helm status archie-core-shopify-layer --namespace archie-core -o json | jq -r '.version')
            echo "ğŸ“ Current production revision: $CURRENT_REVISION"
            echo "BACKUP_REVISION=$CURRENT_REVISION" >> $GITHUB_ENV
          else
            echo "â„¹ï¸  No existing release found - this is a fresh deployment"
            echo "BACKUP_REVISION=none" >> $GITHUB_ENV
          fi

      - name: ğŸ·ï¸ Set deployment image tag
        id: deploy_tag
        run: |
          IMAGE_TAG=${{ inputs.version_tag || github.sha }}
          echo "deploy_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Deploying with image tag: ${IMAGE_TAG}"

      - name: ğŸš€ Deploy with Helm
        run: |
          echo "ğŸš€ Starting Helm deployment to ${{ inputs.environment }}..."
          
          ATOMIC_FLAG="--atomic"
          TIMEOUT="10m"
          
          # Development: non-atomic to allow debugging, longer timeout
          if [ "${{ inputs.environment }}" = "development" ]; then
            ATOMIC_FLAG=""  # Don't use atomic for development to allow debugging
            TIMEOUT="20m"   # Longer timeout for development
            echo "ğŸ”§ Development mode: non-atomic deployment with extended timeout"
          fi
          
          # Production gets special treatment
          if [ "${{ inputs.enable_production_validations }}" = "true" ]; then
            ATOMIC_FLAG=""  # Don't use atomic for production to allow manual rollback
            TIMEOUT="15m"   # Longer timeout for production
            echo "ğŸ”’ Production deployment mode enabled"
          fi

          # First attempt - normal deployment
          if helm upgrade --install archie-core-shopify-layer ./helm-chart \
            --namespace archie-core \
            --create-namespace \
            --values ./helm-chart/${{ inputs.values_file }} \
            --set image.repository=${{ vars.DOCKER_REGISTRY_URL }}/shopify-integration-service \
            --set image.tag=${{ steps.deploy_tag.outputs.deploy_tag }} \
            --set-string app.port="${{ vars.SERVER_PORT || '8080' }}" \
            --set-string app.environment="${{ inputs.environment }}" \
            --set-string mongodb.uri="${{ secrets.MONGO_URI }}" \
            --set-string mongodb.database="${{ vars.MONGODB_DATABASE || 'shopify_layer' }}" \
            --set-string encryption.key="${{ secrets.ENCRYPTION_KEY }}" \
            --set-string shopify.apiKey="${{ secrets.SHOPIFY_API_KEY }}" \
            --set-string shopify.apiSecret="${{ secrets.SHOPIFY_API_SECRET }}" \
            --set-string appUrl="${{ vars.APP_URL || 'http://localhost:8080' }}" \
            --set-string redis.url="${{ secrets.REDIS_URL }}" \
            --wait \
            --timeout=$TIMEOUT \
            $ATOMIC_FLAG; then
            echo "âœ… ${{ inputs.environment }} deployment completed successfully!"
          else
            echo "âŒ First deployment attempt failed. Checking release status..."

            # Check if the release exists and is in a bad state
            if helm status archie-core-shopify-layer --namespace archie-core >/dev/null 2>&1; then
              RELEASE_STATUS=$(helm status archie-core-shopify-layer --namespace archie-core -o json | jq -r '.info.status')
              echo "ğŸ” Current release status: $RELEASE_STATUS"

              if [ "$RELEASE_STATUS" = "failed" ] || [ "$RELEASE_STATUS" = "pending-upgrade" ] || [ "$RELEASE_STATUS" = "pending-install" ]; then
                echo "ğŸ” Debugging before force deployment..."
                echo "ğŸ“Š Current pod status:"
                kubectl get pods -n archie-core -l app=archie-core-shopify-layer -o wide || true
                echo ""
                echo "ğŸ“‹ Pod details:"
                kubectl describe pods -n archie-core -l app=archie-core-shopify-layer || true
                echo ""
                echo "ğŸ“ Recent events:"
                kubectl get events -n archie-core --sort-by='.lastTimestamp' | tail -30 || true
                echo ""
                # Get logs from any existing pod
                POD_NAME=$(kubectl get pods -n archie-core -l app=archie-core-shopify-layer -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
                if [ -n "$POD_NAME" ]; then
                  echo "ğŸ“ Logs from pod $POD_NAME:"
                  kubectl logs -n archie-core $POD_NAME --tail=100 || true
                  echo "ğŸ“ Previous container logs (if any):"
                  kubectl logs -n archie-core $POD_NAME --previous --tail=100 || true
                fi
                echo ""
                echo "ğŸ”¨ Attempting force deployment WITHOUT --wait flag to avoid timeout..."
                
                # Force deployment without --wait to avoid timeout, then check status separately
                helm upgrade --install archie-core-shopify-layer ./helm-chart \
                  --namespace archie-core \
                  --create-namespace \
                  --values ./helm-chart/${{ inputs.values_file }} \
                  --set image.repository=${{ vars.DOCKER_REGISTRY_URL }}/shopify-integration-service \
                  --set image.tag=${{ steps.deploy_tag.outputs.deploy_tag }} \
                  --set-string app.port="${{ vars.SERVER_PORT || '8080' }}" \
                  --set-string app.environment="${{ inputs.environment }}" \
                  --set-string mongodb.uri="${{ secrets.MONGO_URI }}" \
                  --set-string mongodb.database="${{ vars.MONGODB_DATABASE || 'shopify_layer' }}" \
                  --set-string encryption.key="${{ secrets.ENCRYPTION_KEY }}" \
                  --set-string shopify.apiKey="${{ secrets.SHOPIFY_API_KEY }}" \
                  --set-string shopify.apiSecret="${{ secrets.SHOPIFY_API_SECRET }}" \
                  --set-string appUrl="${{ vars.APP_URL || 'http://localhost:8080' }}" \
                  --set-string redis.url="${{ secrets.REDIS_URL }}" \
                  --force || true
                
                echo "â³ Waiting 90 seconds for pods to initialize and show logs..."
                sleep 90
                
                echo "ğŸ“Š Pod status after force deployment:"
                kubectl get pods -n archie-core -l app=archie-core-shopify-layer -o wide || true
                echo ""
                
                # Get the latest pod and show detailed logs
                LATEST_POD=$(kubectl get pods -n archie-core -l app=archie-core-shopify-layer --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}' 2>/dev/null || echo "")
                if [ -n "$LATEST_POD" ]; then
                  echo "ğŸ“ Current logs from pod $LATEST_POD:"
                  kubectl logs -n archie-core $LATEST_POD --tail=200 || true
                  echo ""
                  echo "ğŸ“ Previous container logs (if crashed):"
                  kubectl logs -n archie-core $LATEST_POD --previous --tail=200 || true
                  echo ""
                  echo "ğŸ“‹ Pod description:"
                  kubectl describe pod -n archie-core $LATEST_POD || true
                fi
                
                # For development, don't fail - just show status
                if [ "${{ inputs.environment }}" = "development" ]; then
                  echo "âš ï¸  Development deployment completed (may not be fully ready). Check pod logs above to diagnose the issue."
                  echo "ğŸ’¡ Common issues:"
                  echo "   - MongoDB connection failure (check MONGODB_URI secret)"
                  echo "   - Missing ENCRYPTION_KEY (check ENCRYPTION_KEY secret)"
                  echo "   - Application startup errors (check logs above)"
                else
                  echo "âŒ Force deployment completed but pods may not be ready. Check logs above."
                  exit 1
                fi
              fi
            else
              echo "âŒ Release not found. Deployment was rolled back due to atomic flag."
              echo "ğŸ” Debugging deployment failure..."
              
              # Show current pod status for debugging
              echo "ğŸ“Š Current pod status:"
              kubectl get pods -n archie-core -l app=archie-core-shopify-layer || echo "No pods found"
              
              # Show recent events
              echo "ğŸ“‹ Recent events in namespace:"
              kubectl get events -n archie-core --sort-by='.lastTimestamp' | tail -20 || true
              
              # Try to get any existing pod logs
              EXISTING_POD=$(kubectl get pods -n archie-core -l app=archie-core-shopify-layer -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
              if [ -n "$EXISTING_POD" ]; then
                echo "ğŸ“ Logs from pod $EXISTING_POD:"
                kubectl logs -n archie-core $EXISTING_POD --tail=50 || true
                echo "ğŸ“ Previous container logs (if any):"
                kubectl logs -n archie-core $EXISTING_POD --previous --tail=50 || true
              fi
              
              # For production, attempt rollback
              if [ "${{ inputs.enable_production_validations }}" = "true" ] && [ "$BACKUP_REVISION" != "none" ]; then
                echo "ğŸ”„ Attempting automatic rollback to revision $BACKUP_REVISION..."
                if helm rollback archie-core-shopify-layer $BACKUP_REVISION --namespace archie-core --wait --timeout=10m; then
                  echo "âœ… Rollback completed successfully"
                  echo "âŒ Production deployment failed but rollback succeeded"
                  exit 1
                else
                  echo "âŒ Rollback also failed - manual intervention required!"
                  exit 1
                fi
              fi
              
              echo "âŒ Deployment failed. Check the logs above for details."
              exit 1
            fi
          fi

      - name: ğŸ” Debug pod status (if deployment failed)
        if: failure()
        run: |
          echo "ğŸ” Debugging deployment failure..."
          echo "ğŸ“Š Pod status:"
          kubectl get pods -n archie-core -l app=archie-core-shopify-layer -o wide || true
          echo ""
          echo "ğŸ“‹ Pod details:"
          kubectl describe pods -n archie-core -l app=archie-core-shopify-layer || true
          echo ""
          echo "ğŸ“ Recent events:"
          kubectl get events -n archie-core --sort-by='.lastTimestamp' | tail -30 || true
          echo ""
          # Try to get logs from any pod
          POD_NAME=$(kubectl get pods -n archie-core -l app=archie-core-shopify-layer -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$POD_NAME" ]; then
            echo "ğŸ“ Logs from pod $POD_NAME:"
            kubectl logs -n archie-core $POD_NAME --tail=100 || true
          fi

      - name: âœ… Verify deployment
        run: |
          echo "âœ… ${{ inputs.environment }} deployment completed successfully!"
          kubectl get pods -n archie-core -l app=archie-core-shopify-layer
          kubectl get services -n archie-core -l app=archie-core-shopify-layer
          kubectl get hpa -n archie-core -l app=archie-core-shopify-layer

      - name: ğŸ§ª Basic deployment verification
        run: |
          echo "ğŸ§ª Verifying ${{ inputs.environment }} deployment..."
          
          # Just wait for pods to be ready (basic verification)
          echo "â³ Waiting for pods to be ready..."
          kubectl wait --for=condition=ready pod -l app=archie-core-shopify-layer -n archie-core --timeout=300s
          
          echo "âœ… All pods are ready - deployment successful!"

      - name: ğŸ“ Create deployment record (production only)
        if: ${{ inputs.enable_production_validations }}
        run: |
          echo "ğŸ“ Recording successful production deployment..."
          echo "ğŸ·ï¸  Version: ${{ inputs.version_tag || github.sha }}"
          echo "ğŸ“… Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"

